.. _source_tracking:

==================================================
Tracking the source of microbes with SourceTracker
==================================================

Introduction
------------
This tutorial illustrations how to use the SourceTracker 0.9.4 software. SourceTracker is a software package designed to predict the source of microbial communities in a given environment type. See `Knights (2011) <http://www.nature.com/nmeth/journal/v8/n9/full/nmeth.1650.html>`_ for the original paper on SourceTracker.

This tutorial does not attempt to cover every possible usage of Source Tracker. Instead, it attempts to provide a useful examples of how to use these statistical methods in your own analysis.

Input Files
-----------
You can obtain the files used in this tutorial `here <https://www.dropbox.com/s/f4yikgac95ivkru/sourcetracker_tutorial_files.zip?m>`_. The files are taken from a study (Hewitt et al., 2013), where samples were collected from various surfaces in three different NICUs. These samples were sequenced and then analyzed against existing data sets using SourceTracker in order to predict the likely origin of the microbial contaminants on each specific NICU surface.

Output Files
------------
The output files generated by this script will vary. They will all be placed in the directory specified by the required ``-o`` option. The files generated by this script contain charts and graphs and are in the pdf format. These can be viewed with a web browser or any other image viewing software.

Test Usage
----------
Before running SourceTracker check to see if it installed and accessible to QIIME::

    print_qiime_config.py -t

You should see the following line in the output if SourceTracker is properly installed::

	sourcetracker is installed ... ok

For information on interacting with SourceTracker, run the following command to get SourceTracker's help information::

    R --slave --vanilla --args -h < $SOURCETRACKER_PATH/sourcetracker_for_qiime.r

The ``$SOURCETRACKER_PATH`` environment variable referenced here will be defined if SourceTracker is correctly installed.

Filter otu table by 1%
----------------------
This command will filter any OTUs that are present in less than 1% of the samples. Note that this value is determined by your dataset, in some cases is fine to run with all your samples or a different minimum percent. The number of samples in the OTU table can be obtained by running per_library_stats.py on the OTU table. To filter the OTU table Run the following command::

    filter_otus_from_otu_table.py -i otu_table.biom -o filtered_otu_table.biom -s 7

This command will create an output file named :file:`filtered_otu_table.biom`, this is thew new otu table that has all OTUs appearing in les than 1% of the samples removed. The input to the -s command should be 1 percent of the samples in the original OTU table.

Convert table from .biom to .txt
--------------------------------
SourceTracker does not work with the biom format. In order to run SourceTracker the OTU table needs to be converted to .txt.
To convert the OTU table to text format run the following command::

    convert_biom.py -i filtered_otu_table_100.biom -o filtered_otu_table_100.txt -b

This creates a file named :file:`filtered_otu_table_100.txt` which is the OTU table in text format. 

Run SourceTracker
-----------------

Note: The mapping must contain two columns titled 'SourceSink', and 'Env'. These columns were added to the mapping file by opening it in Excel or as a Google Spreadsheet and adding the new columns. In this data set the sources are 'Outdoor Air', 'Human Skin', 'Human Mouth'... each row that represents a sample taken from one of these was labeled 'source' in the SourceSink column. Likewise the sink samples: 'NICU Incubator', 'NICU BabyBedside',... are labeled 'sink' under the SourceSink 
Column. each row in the 'Env' column should contain the name of the source and sink samples that will be used in the analysis, for example. 'Outdoor Air', 'Human Skin', 'Human Mouth'... Any sample that will not be used in the analysis should contain 'NA' in the 'SourceSink' and 'Env' columns.

In order to run SourceTracker run the following command::

    R --slave --vanilla --args -i filtered_otu_table_100.txt -m map.txt -o sourcetracker_out < $SOURCETRACKER_PATH/sourcetracker_for_qiime.r



Open up :file:`sink_predictions_pie_NICU BabyBedside.pdf` to view an example of the output:

.. image:: ../images/sink_predictions_pie_NICU_BabyBedside.png
   :align: center

These pie charts represent the likely origin of microbial communities from each sample taken from the BabyBedside. Each of the colors in the bar chart represent one of the sources that were denoted in the mapping file. The precent of the chart for each source is relative to how similar the sample is to that source. 

References
----------

Knights, Dan et al. "Bayesian community-wide culture-independent microbial source tracking." Nature Methods(2011)761-763 SHOULD I USE THE DOI HERE? OR SOMETHING ELSE?

Hewitt, Krissi M et al. "Bacterial Diversity in Two Neonatal Intensive Care Units (NICUs)." PLOS ONE (2013)